# 单一写入原则

> PLC暴露给PC的地址，必须满足任一地址都必须满足只允许一方写入，另一方绝不允许写入。
>
> 上位机批量写入，会使用读-改-写原则，这样可以避免错误的覆盖寄存器的值。

是的，这绝对是避免bug和确保系统稳定、可靠的最佳实践和黄金准则。

您提到的 **“下位机PLC提供给上位机的地址，必须满足只能允许一方写，另一方只读”** 的原则，在工业自动化领域通常被称为 **“单一写入者原则”（Single Writer Principle）**。

这不仅仅是一个约定，更是保障系统安全、可预测和易于维护的基石。



### 为什么这是最佳实践？



如果您违反了这个原则，允许PLC和上位机（如SCADA、HMI、PC程序）同时拥有对同一个地址的写入权限，会立刻引入一系列严重且难以调试的问题：

1. **数据竞争 (Race Condition):** 这是最核心、最危险的问题。PLC和上位机可能在几乎完全相同的时间点去写入同一个地址。最终该地址保存的是谁写入的值，取决于网络延迟、程序扫描周期等一系列不可控的因素。这会导致系统的行为变得完全随机和不可预测。
   - **例子：** 一个控制水泵启停的地址 `D100`。上位机因为检测到水位过高写入 `1` (启动)，而几乎同时，PLC因为本地急停按钮被按下而写入 `0` (停止)。水泵最终是启动还是停止？它可能会快速启停（“抖动”），或者处于一个不确定的状态，这可能损坏设备。
2. **数据覆盖与丢失 (Data Corruption):** 一个系统写入的重要数据，可能在它被处理之前就被另一个系统覆盖掉了。
   - **例子：** PLC计算出了一个关键的生产批次号 `12345` 并写入地址 `D200`。但上位机因为一个不相关的操作（比如用户点击了界面的一个“复位”按钮），向同一个地址 `D200` 写入了 `0`。PLC后续的程序逻辑拿到的就是错误的数据 `0`，可能导致整个批次的生产记录错误。
3. **控制权冲突与逻辑混乱 (Command Confusion):** 系统的“指挥官”变得不明确。PLC和上位机都在试图控制设备，会导致指令冲突。
   - **例子：** 上位机发送指令写入 `M100`，要求设备进入“自动模式”。同时，现场操作员在PLC侧通过HMI操作，使PLC写入 `M100` 要求设备进入“手动模式”。设备到底应该执行哪个模式？这会导致设备逻辑混乱，甚至产生安全风险。
4. **极难调试 (Debugging Nightmare):** 当一个数据出错时，问题排查会变得极其困难。您无法确定这个错误的值是PLC写入的，还是上位机写入的。您需要同时检查两边的程序逻辑和执行时序，这在复杂的系统中几乎是不可能完成的任务。



### 正确的实现方法：清晰的地址规划



为了严格遵守“单一写入者原则”，在项目初期就必须做好清晰的 **内存地址规划（Memory Mapping）**。通常会把地址区域划分为：

- **PLC写入区 (上位机只读):**
  - **功能：** 用于PLC向上位机报告自身状态、传感器数据、设备报警、生产计数等。
  - **例子：**
    - `D10-D19`: 产线各工位的实时温度。
    - `M0-M99`: 设备的运行/停止/报警状态位。
    - `D100`: 当前的生产产量。
- **上位机写入区 (PLC只读):**
  - **功能：** 用于上位机向PLC发送指令、设定参数、下发配方等。
  - **例子：**
    - `D200-D209`: 从上位机下发的产品配方参数。
    - `M100-M109`: 上位机发送的启动/停止/复位等控制命令位。
    - `D300`: 上位机设定的目标产量。



### 特殊情况：需要交接控制权怎么办？



有时候确实需要双方都能“修改”某个状态，但这并不意味着要破坏单一写入者原则。正确的方法是使用 **“握手协议”（Handshake Protocol）**。

例子：请求/允许机制

假设上位机需要请求PLC执行一个清零操作。

1. **地址规划:**
   - `M200`: 上位机写入区。`PC_Request_Clear` (PC请求清零)。
   - `M300`: PLC写入区。`PLC_Acknowledge_Clear` (PLC确认清零完成)。
2. **流程:**
   - 上位机想清零时，将 `M200` 置 `1`。
   - PLC在其扫描周期中检测到 `M200` 为 `1`。
   - PLC执行清零逻辑。
   - 清零完成后，PLC将 `M300` 置 `1`，并可能在内部逻辑中复位 `M200` (或者由上位机复位)。
   - 上位机检测到 `M300` 为 `1`，就知道操作已成功，然后将自己的请求位 `M200` 复位为 `0`。
   - PLC检测到 `M200` 变为 `0`，也将自己的确认位 `M300` 复位为 `0`，完成一次握手。

在这个过程中，`M200` 的写入权永远属于上位机，`M300` 的写入权永远属于PLC。双方通过读写**不同的地址**来完成一次交互，完美地遵守了单一写入者原则。



### 结论



**“只允许一方写，另一方只读”** 不仅仅是一个“约定”，它是工业控制领域经过数十年实践检验的、用于构建稳定、可靠、安全和易于维护系统的核心设计原则。任何时候都应该严格遵守它。违反这一原则所节省的任何短期开发便利，都会在未来系统调试和维护中带来百倍的痛苦和风险。



# 批量读取和写入的优点

比如气缸有两个di信号表示到位，如果批量读，则不会出现两个di信号由于时间差，同时出现有效的情况。比如100ms读到上信号有效，200ms时，运动到下，220ms读取到下信号有效，这时判断到两个信号同时有效，错误的报警，状态不对。