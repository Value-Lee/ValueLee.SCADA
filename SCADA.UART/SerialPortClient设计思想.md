SerialPortClient



## 连接和断连

TCP的连接成功，必须满足，双方网线连接正常，对方开机，对方建立了TCP服务器，作为客户端才能连接成功。

串口不一样。

双方即使没有用线连接，即使对方没有开机，己方仍旧能正常打开串口，所以Port.IsOpen不能作为连接成功。

发送给对方消息且收到回复，这才算连接成功的标志。

封装后的串口，加了协议层，如果己方发送错误的请求，导致对方未回复，或者对方正常回复，但是受到正常

不是硬件有没有问题，而是这个通信链路是否满足正常请求响应模式，如果不能，不论是因为电磁干扰，连接线断开，还是双方无法按照协议正常解析，都认为是断开。

即使某一次发生协议解析失败，且尝试了2次以上的重试，仍旧不行，被认为不会无缘无故的失败，只要一条没按照协议，都认为这条链路不可靠，标记链路故障，让用户去检查磁场环境，连接线，甚至是检查应用层协议，代码逻辑，某次是否封装错误的请求字节，或者不能正常解析响应帧。后者虽然是代码原因，仍被认作是硬件不可靠，处于断连状态。



某个请求失败的原因：

## 应当有重发功能

- 受电磁干扰，传送到Device错误的字节流。如发送某个字节时，第3个bit位时间，电磁干扰，线路上的电平发生瞬时跳变，接收方检测到线路电平是反的，导致这个字节数据是错误的，如果后续进行CRC校验，肯定失败。又或者起始点电平应该是低电平，但是刚好跳变，Device会晚1或多个电平时间检测到低电平。

  所以，这会导致Device未收到正确的请求字节，导致自身不应答，或者回复我收到错误的帧。

- Device正确应答，同样因为电磁干扰，客户端校验数据失败，或者没收到完整的帧结束符号。

- 重试2次后，仍旧不行，那就是电磁干扰过于严重，认为信道不可靠，直接停止。



- 信道的第二个功能是解析响应帧和发送响应帧。



SerialPortClient功能

接收字节

发送字节

打开串口

过滤帧

什么是故障

- 打开串口失败
- 解析帧失败

发生故障后

- 禁止发起新的请求
- 标记缓存中的请求全部取消并清空
- Monitor立刻返回，不进行实际工作